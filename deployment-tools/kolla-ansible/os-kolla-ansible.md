## Prompt:
---

## Installation OpenStack Xena on VM Cloud

## Environment
```
1. Virtual Machine Ubuntu 20.04LTS (Azure, GCP, AWS, Aliyun, etc)
2. 16GB RAM
3. 512 GB Storage
4. One disk add for PV
```

## Prepare
```
sudo apt update -y && sudo apt-get full-upgrade -y
```

## Create Dummy Interface
```
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
```

## Define on Hosts file
```
sudo tee /etc/hosts << EOT
$(hostname -i) $(hostname)
EOT
```

## Prepare Kolla User
```
Add User :
adduser kolla
usermod -aG sudo kolla
echo "kolla ALL=(ALL) NOPASSWD:ALL" | tee /etc/sudoers.d/kolla

su - kolla
```

## Create a PV
```
sudo pvcreate /dev/sdc
sudo vgcreate cinder-volumes /dev/sdc
sudo vgs
```

## Install Dependencies
```
sudo apt-get install python3-dev libffi-dev gcc libssl-dev python3-selinux python3-setuptools python3-venv -y
```

## Create a Virtual Environment 
```
python3 -m venv kolla-venv
source kolla-venv/bin/activate
```

## Install some pip package
```
apt install -y python3-docker
pip install -U pip
pip install wheel
pip install 'ansible<3.0'
```

## Config ansible.cfg
```
sudo mkdir -p /etc/ansible
sudo nano /etc/ansible/ansible.cfg
```
```
[defaults]
host_key_checking=False
pipelining=True
forks=100
```

## Install Kolla-Ansible
```
You can see the support version on :
https://releases.openstack.org/teams/kolla.html  
```
```
pip install 'kolla-ansible==13.0.1'
```

## Create Kolla Directory
```
sudo mkdir -p /etc/kolla
sudo chown $USER:$USER /etc/kolla
```

## Copy some file & dir
```
cp -r kolla-venv/share/kolla-ansible/etc_examples/kolla/* /etc/kolla
cp kolla-venv/share/kolla-ansible/ansible/inventory/* .
```

## Check Configuration is correct or not
```
ansible -i all-in-one all -m ping
```

## Generate Password and change to "kolla"
```
kolla-genpwd
sed -i 's#keystone_admin_password:.*#keystone_admin_password: kolla#g' /etc/kolla/passwords.yml
```

## Edit globals.yml
```
nano /etc/kolla/globals.yml
```
```
You can use "qemu" or "kvm"

if using "kvm", make sure Nested Virtualization is on.
To check : 
cat /sys/module/kvm_intel/parameters/nested
Y is activated.
```
```
kolla_base_distro: "ubuntu"
kolla_install_type: "source"
openstack_release: "xena"
kolla_internal_vip_address: "10.0.0.4"
network_interface: "eth0"
neutron_external_interface: "br_ex_port"
enable_openstack_core: "yes"
enable_haproxy: "no"
enable_neutron_provider_networks: "yes"
nova_compute_virt_type: "kvm"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
cinder_volume_group: "cinder-volumes"
```
```
kolla_internal_vip_address is your ip-eth0
```

## Run Kolla Ansible
```
kolla-ansible -i ./all-in-one bootstrap-servers
kolla-ansible -i ./all-in-one prechecks
kolla-ansible -i ./all-in-one deploy
kolla-ansible post-deploy
```

## Install Openstack Client
```
On Virtual Environment :
pip install python-openstackclient
pip install python-magnumclient

On OS :
apt install python3-openstackclient
```

## Verification
```
source /etc/kolla/admin-openrc.sh
openstack server list
```

## Access Dashboard
```
Access on your_vm_ip

Username : admin
Password : kolla
```

## Public Network
```
TYPE : flat
physnet1
```

## Init some First Instance
```
export EXT_NET_CIDR='10.0.2.0/24'
export EXT_NET_RANGE='start=10.0.2.150,end=10.0.2.199'
export EXT_NET_GATEWAY='10.0.2.1'
source /etc/kolla/admin-openrc.sh
./kolla-venv/share/kolla-ansible/init-runonce
```

## IP Route for Instance Internet Access
```
sudo ifconfig br-ex $EXT_NET_GATEWAY netmask 255.255.255.0 up
sudo iptables -t nat -A POSTROUTING -s $EXT_NET_CIDR -o eth0 -j MASQUERADE
```

## What to do when restarting OpenStack Cluster
```
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
export EXT_NET_CIDR='10.0.2.0/24'
export EXT_NET_RANGE='start=10.0.2.150,end=10.0.2.199'
export EXT_NET_GATEWAY='10.0.2.1'
sudo ifconfig br-ex $EXT_NET_GATEWAY netmask 255.255.255.0 up
sudo iptables -t nat -A POSTROUTING -s $EXT_NET_CIDR -o eth0 -j MASQUERADE
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -A FORWARD -o eth0 -i br-ex -j ACCEPT
iptables -A FORWARD -i eth0 -o br-ex -j ACCEPT
```

## Destroy Cluster
```
You can simply destroy your openstack cluster with :
kolla-ansible -i all-in-one destroy
```

## Port Forwarding
```
You can forward Instance IP to another port on your VM Public IP.

For example i want to forward Instance IP on 10.0.2.155:22 to Your_VM_Public_IP:2000
So, you can do this :
$ iptables -t nat -A PREROUTING -p tcp --dport 2000 -d 10.0.0.4 -j DNAT --to-destination 10.0.2.155:22

NB : 10.0.0.4 is your eth0 VM && 10.0.2.155 is your Instance floating IP
Now, you can access your Instance SSH publicly on Your_VM_Public_IP:2000
```

## Victoria Version
```
https://gist.github.com/gilangvperdana/e74b3536c0c8786c68cb3ed51e4acbd2  
```

## Other
If you want to see my openstack installation article :
- [on my Medium](https://gilangvperdana.medium.com/list/openstack-916ca8cdc5cf  )
- [Xena AIO](https://gist.github.com/gilangvperdana/7042caa2af2c7729c798581a86509e8d  )


ржЖржорж╛ржХрзЗ ржПржЗ installation guides рж╕ржорзНржкрж░рзНржХрзЗ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржмрж▓рзБржи

---

### ASSISTANT
ржЕржмрж╢рзНржпржЗ! ржирж┐ржЪрзЗрж░ ржЧрж╛ржЗржбржЯрж┐ **OpenStack Xena**-ржПрж░ ржПржХржЯрж┐ **All-in-One (AIO)** рж╕ржВрж╕рзНржХрж░ржг ржЗржирж╕рзНржЯрж▓ ржХрж░рж╛рж░ ржЬржирзНржп, ржпрж╛ **Kolla-Ansible** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржирзЗ (VM) ржкрзНрж░рзЛржбрж╛ржХрж╢ржи-рж░рзЗржбрж┐ ржорждрзЛ рж╕рзЗржЯржЖржк рждрзИрж░рж┐ ржХрж░рзЗред ржПржЦрж╛ржирзЗ ржЖржорж┐ ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ рж╕ржорзНржкрзВрж░рзНржг ржЧрж╛ржЗржбржЯрж┐ ржмрж┐рж╕рзНрждрж╛рж░рж┐рждржнрж╛ржмрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░ржЫрж┐, ржпрж╛рждрзЗ ржЖржкржирж┐ рж╕рж╣ржЬрзЗ ржмрзБржЭрждрзЗ ржкрж╛рж░рзЗржи ржПржмржВ ржмрж╛рж╕рзНрждржмрж╛ржпрж╝ржи ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред

---

## ЁЯМР ржУржнрж╛рж░ржнрж┐ржЙ: OpenStack Xena on VM using Kolla-Ansible

ржПржЗ ржЧрж╛ржЗржбржЯрж┐ **Kolla-Ansible** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ OpenStack Xena рж╕ржВрж╕рзНржХрж░ржг ржПржХржЯрж┐ ржПржХржХ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржирзЗ (All-in-One) ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рж╛рж░ ржЬржирзНржпред  
Kolla-Ansible рж╣рж▓рзЛ OpenStack ржХржорзНржкрзЛржирзЗржирзНржЯржЧрзБрж▓рзЛржХрзЗ Docker ржХржирзНржЯрзЗржЗржирж╛рж░рзЗ ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржЕржЯрзЛржорзЗрж╢ржи ржЯрзБрж▓, ржпрж╛ Ansible ржжрзНржмрж╛рж░рж╛ ржЪрж╛рж▓рж┐ржд рж╣ржпрж╝ред

> тЬЕ **ржЙржжрзНржжрзЗрж╢рзНржп**: рж╢рзЗржЦрж╛рж░, ржЯрзЗрж╕рзНржЯрж┐ржВ ржмрж╛ PoC (Proof of Concept)-ржПрж░ ржЬржирзНржп ржПржХржЯрж┐ рж╕ржорзНржкрзВрж░рзНржг ржХрж╛ржЬрзЗрж░ OpenStack ржХрзНрж▓рж╛ржЙржб рждрзИрж░рж┐ ржХрж░рж╛ред

---

## тЪЩя╕П ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржкрж░рж┐ржмрзЗрж╢ (Environment)

| ржЖржЗржЯрзЗржо | ржмрж┐ржмрж░ржг |
|-------|--------|
| OS | Ubuntu 20.04 LTS |
| RAM | 16 GB |
| Storage | 512 GB + ржЕрждрж┐рж░рж┐ржХрзНржд ржбрж┐рж╕рзНржХ `/dev/sdc` (LVM ржПрж░ ржЬржирзНржп) |
| рж╣рзЛрж╕рзНржЯрж┐ржВ | Azure, GCP, AWS, Aliyun ржмрж╛ ржпрзЗржХрзЛржирзЛ ржХрзНрж▓рж╛ржЙржб VM |

> ЁЯТб ржирзЛржЯ: OpenStack AIO рж╕рзЗржЯржЖржкрзЗрж░ ржЬржирзНржп ржХржоржкржХрзНрж╖рзЗ 8GB RAM ржкрзНрж░ржпрж╝рзЛржЬржи, ржХрж┐ржирзНрждрзБ 16GB ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржнрж╛рж▓рзЛ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ред

---

## ЁЯФз ржзрж╛ржк рзз: рж╕рж┐рж╕рзНржЯрзЗржо ржЖржкржбрзЗржЯ ржУ ржкрзНрж░рж╕рзНрждрзБрждрж┐

```bash
sudo apt update -y && sudo apt-get full-upgrade -y
```
- рж╕рж┐рж╕рзНржЯрзЗржорзЗрж░ рж╕ржм ржкрзНржпрж╛ржХрзЗржЬ ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред

---

## ЁЯМР ржзрж╛ржк рзи: ржПржХржЯрж┐ ржбрж╛ржорж┐ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ рждрзИрж░рж┐ (`br_ex_port`)

```bash
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
```
- `br_ex_port` рж╣рж▓рзЛ ржПржХржЯрж┐ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕, ржпрж╛ Neutron-ржПрж░ **external network** рж╣рж┐рж╕рж╛ржмрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржмрзЗред
- ржПржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржирзЗрж░ ржмрж╛ржЗрж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ (public/flat network) ржПрж░ ржЬржирзНржпред

---

## ЁЯЦея╕П ржзрж╛ржк рзй: `/etc/hosts` ржлрж╛ржЗрж▓рзЗ рж╣рзЛрж╕рзНржЯ ржирж╛ржо рж╕рзЗржЯ ржХрж░рж╛

```bash
sudo tee /etc/hosts << EOT
$(hostname -i) $(hostname)
EOT
```
- рж╣рзЛрж╕рзНржЯрзЗрж░ IP ржПржмржВ рж╣рзЛрж╕рзНржЯржирзЗржо ржорзНржпрж╛ржк ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред Kolla-Ansible ржПржЯрж┐ ржЪрзЗржХ ржХрж░рзЗред

---

## ЁЯСд ржзрж╛ржк рзк: Kolla ржЗржЙржЬрж╛рж░ рждрзИрж░рж┐ ржХрж░рж╛

```bash
adduser kolla
usermod -aG sudo kolla
echo "kolla ALL=(ALL) NOPASSWD:ALL" | tee /etc/sudoers.d/kolla
su - kolla
```
- ржирждрзБржи ржЗржЙржЬрж╛рж░ `kolla` рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред
- ржПржЗ ржЗржЙржЬрж╛рж░ржХрзЗ sudo ржЕржзрж┐ржХрж╛рж░ ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝рзЗржЫрзЗред
- Kolla-Ansible рж╕рж╛ржзрж╛рж░ржгржд ржПржЗ ржЗржЙржЬрж╛рж░рзЗрж░ ржЕржзрзАржирзЗ ржЪрж╛рж▓рж╛ржирзЛ рж╣ржпрж╝ред

---

## ЁЯТ╛ ржзрж╛ржк рзл: LVM ржкрзНрж░рж╕рзНрждрзБрждрж┐ (Cinder-ржПрж░ ржЬржирзНржп)

```bash
sudo pvcreate /dev/sdc
sudo vgcreate cinder-volumes /dev/sdc
sudo vgs
```
- `/dev/sdc` ржХрзЗ Physical Volume (PV) рж╣рж┐рж╕рж╛ржмрзЗ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рж╛ рж╣рж▓рзЛред
- `cinder-volumes` ржирж╛ржорзЗ ржПржХржЯрж┐ Volume Group (VG) рждрзИрж░рж┐ ржХрж░рж╛ рж╣рж▓рзЛред
- ржПржЯрж┐ Cinder (Block Storage) рж╕рж╛рж░рзНржнрж┐рж╕ ржжрзНржмрж╛рж░рж╛ ржмрзНржпржмрж╣рзГржд рж╣ржмрзЗред

> тЪая╕П ржирзЛржЯ: `/dev/sdc` ржХрзЗржмрж▓ ржЙржжрж╛рж╣рж░ржгред ржЖржкржирж╛рж░ рж╕рж┐рж╕рзНржЯрзЗржорзЗ `lsblk` ржжрж┐ржпрж╝рзЗ ржЪрзЗржХ ржХрж░рзБржи ржХрзЛржи ржбрж┐рж╕рзНржХржЯрж┐ ржЦрж╛рж▓рж┐ред

---

## ЁЯУж ржзрж╛ржк рзм: ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржбрзЗржкрзЗржиржбрзЗржирзНрж╕рж┐ ржЗржирж╕рзНржЯрж▓

```bash
sudo apt-get install python3-dev libffi-dev gcc libssl-dev python3-selinux python3-setuptools python3-venv -y
```
- Python ржПржмржВ C ржХржорзНржкрж╛ржЗрж▓рж╛рж░ рж╕ржВржХрзНрж░рж╛ржирзНржд ржЯрзБрж▓рж╕ ржЗржирж╕рзНржЯрж▓ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред
- Ansible ржПржмржВ Kolla-Ansible ржПржЧрзБрж▓рзЛрж░ ржЙржкрж░ ржирж┐рж░рзНржнрж░рж╢рзАрж▓ред

---

## ЁЯРН ржзрж╛ржк рзн: Python Virtual Environment рждрзИрж░рж┐

```bash
python3 -m venv kolla-venv
source kolla-venv/bin/activate
```
- ржПржХржЯрж┐ ржЖрж▓рж╛ржжрж╛ Python ржкрж░рж┐ржмрзЗрж╢ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред
- ржПржЯрж┐ ржбрж┐ржкрзЗржиржбрзЗржирзНрж╕рж┐ ржХржиржлрзНрж▓рж┐ржХрзНржЯ ржПржбрж╝рж╛рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗред

---

## ЁЯРН ржзрж╛ржк рзо: Python ржкрзНржпрж╛ржХрзЗржЬ ржЗржирж╕рзНржЯрж▓

```bash
apt install -y python3-docker
pip install -U pip
pip install wheel
pip install 'ansible<3.0'
```
- `python3-docker`: Docker API ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛рж░ ржЬржирзНржпред
- `ansible<3.0`: Kolla-Ansible Xena рж╕ржВрж╕рзНржХрж░ржг Ansible 2.x рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗред

---

## тЪЩя╕П ржзрж╛ржк рзп: Ansible ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи

```bash
sudo mkdir -p /etc/ansible
sudo nano /etc/ansible/ansible.cfg
```

### ржХржиржЯрзЗржирзНржЯ:
```ini
[defaults]
host_key_checking=False
pipelining=True
forks=100
```
- `host_key_checking=False`: SSH host key ржЪрзЗржХ ржмрж╛ржЗржкрж╛рж╕ ржХрж░рзЗред
- `pipelining=True`: Ansible ржПрж░ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржмрж╛ржбрж╝рж╛ржпрж╝ред
- `forks=100`: ржПржХрж╕рж╛ржерзЗ 100ржЯрж┐ ржЯрж╛рж╕рзНржХ ржЪрж╛рж▓рж╛ржирзЛ ржпрж╛ржмрзЗред

---

## ЁЯР│ ржзрж╛ржк рззрзж: Kolla-Ansible ржЗржирж╕рзНржЯрж▓

```bash
pip install 'kolla-ansible==13.0.1'
```
- OpenStack Xena-ржПрж░ ржЬржирзНржп рж╕рж╛ржкрзЛрж░рзНржЯрзЗржб Kolla-Ansible ржнрж╛рж░рзНрж╕ржи рж╣рж▓рзЛ `13.0.1`ред
- ржЖржкржирж┐ [https://releases.openstack.org](https://releases.openstack.org) ржерзЗржХрзЗ ржнрж╛рж░рзНрж╕ржи ржорзНржпрж╛ржЪ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред

---

## ЁЯУБ ржзрж╛ржк рззрзз: Kolla ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ рждрзИрж░рж┐

```bash
sudo mkdir -p /etc/kolla
sudo chown $USER:$USER /etc/kolla
```
- `/etc/kolla` ржбрж┐рж░рзЗржХрзНржЯрж░рж┐рждрзЗ рж╕ржм ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржлрж╛ржЗрж▓ рж░рж╛ржЦрж╛ рж╣ржмрзЗред

---

## ЁЯУД ржзрж╛ржк рззрзи: ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржлрж╛ржЗрж▓ ржХржкрж┐

```bash
cp -r kolla-venv/share/kolla-ansible/etc_examples/kolla/* /etc/kolla
cp kolla-venv/share/kolla-ansible/ansible/inventory/* .
```
- `globals.yml`, `passwords.yml`, `all-in-one` inventory ржлрж╛ржЗрж▓ ржХржкрж┐ ржХрж░рж╛ рж╣рж▓рзЛред
- `all-in-one` рж╣рж▓рзЛ ржПржХржЯрж┐ ржкрзНрж░рж┐-ржбрж┐ржлрж╛ржЗржирзНржб Ansible inventory ржлрж╛ржЗрж▓ред

---

## ЁЯзк ржзрж╛ржк рззрзй: Ansible ржЪрзЗржХ

```bash
ansible -i all-in-one all -m ping
```
- Ansible ржпрзЗ рж╣рзЛрж╕рзНржЯрзЗ ржХрж╛ржЬ ржХрж░рждрзЗ ржкрж╛рж░ржЫрзЗ ржХрж┐ржирж╛ рждрж╛ ржЪрзЗржХ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред
- ржЖржЙржЯржкрзБржЯрзЗ `pong` ржжрзЗржЦрж╛рж▓рзЗ рж╕ржм ржарж┐ржХ ржЖржЫрзЗред

---

## ЁЯФР ржзрж╛ржк рззрзк: ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЬрзЗржирж╛рж░рзЗржЯ ржПржмржВ рж╕рзЗржЯ

```bash
kolla-genpwd
sed -i 's#keystone_admin_password:.*#keystone_admin_password: kolla#g' /etc/kolla/passwords.yml
```
- `kolla-genpwd`: рж╕ржм рж╕рж╛рж░рзНржнрж┐рж╕рзЗрж░ ржЬржирзНржп рж░тАНрзНржпрж╛ржирзНржбржо ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рждрзИрж░рж┐ ржХрж░рзЗред
- рждрж╛рж░ржкрж░ `admin` ржЗржЙржЬрж╛рж░рзЗрж░ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб `kolla` ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ (рж╕рзБржмрж┐ржзрж╛рж░ ржЬржирзНржп)ред

---

## ЁЯЫая╕П ржзрж╛ржк рззрзл: `globals.yml` ржХржиржлрж┐ржЧрж╛рж░ ржХрж░рж╛

```yaml
kolla_base_distro: "ubuntu"
kolla_install_type: "source"
openstack_release: "xena"
kolla_internal_vip_address: "10.0.0.4"
network_interface: "eth0"
neutron_external_interface: "br_ex_port"
enable_openstack_core: "yes"
enable_haproxy: "no"
enable_neutron_provider_networks: "yes"
nova_compute_virt_type: "kvm"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
cinder_volume_group: "cinder-volumes"
```

### ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░:

| ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ | ржмрзНржпрж╛ржЦрзНржпрж╛ |
|-------------|---------|
| `kolla_base_distro` | ржХржирзНржЯрзЗржЗржирж╛рж░рзЗ ржХрзЛржи ржбрж┐рж╕рзНржЯрзНрж░рзЛ (Ubuntu/CentOS) ржмрзНржпржмрж╣рж╛рж░ рж╣ржмрзЗ |
| `openstack_release` | OpenStack рж╕ржВрж╕рзНржХрж░ржг (Xena = 2021.2) |
| `kolla_internal_vip_address` | ржЗржирзНржЯрж╛рж░ржирж╛рж▓ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗрж░ VIP (APIs ржПрж░ HA ржПрж░ ржЬржирзНржп), ржЖржкржирж╛рж░ `eth0` ржПрж░ IP |
| `network_interface` | ржЗржирзНржЯрж╛рж░ржирж╛рж▓ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ |
| `neutron_external_interface` | ржПржХрзНрж╕ржЯрж╛рж░рзНржирж╛рж▓ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ (public) ржПрж░ ржЬржирзНржп ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ |
| `nova_compute_virt_type` | KVM ржмрж╛ QEMU (KVM ржнрж╛рж▓рзЛ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржжрзЗржпрж╝) |
| `enable_cinder` | Block storage ржЪрж╛рж▓рзБ ржХрж░рж╛ |
| `cinder_volume_group` | LVM VG ржирж╛ржо |

> тЪая╕П Nested Virtualization ржЪрж╛рж▓рзБ ржерж╛ржХрж▓рзЗ KVM ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред
>
> ржЪрзЗржХ ржХрж░рзБржи: `cat /sys/module/kvm_intel/parameters/nested`

---

## ЁЯЪА ржзрж╛ржк рззрзм: OpenStack ржбрж┐ржкрзНрж▓ржпрж╝

```bash
kolla-ansible -i ./all-in-one bootstrap-servers
kolla-ansible -i ./all-in-one prechecks
kolla-ansible -i ./all-in-one deploy
kolla-ansible post-deploy
```

| ржХржорж╛ржирзНржб | ржХрж╛ржЬ |
|--------|-----|
| `bootstrap-servers` | рж╣рзЛрж╕рзНржЯ ржкрзНрж░рж╕рзНрждрзБржд ржХрж░рж╛ (ржкрзНржпрж╛ржХрзЗржЬ, ржбрж┐рж░рзЗржХрзНржЯрж░рж┐, ржЗрждрзНржпрж╛ржжрж┐) |
| `prechecks` | Ansible ржПржмржВ рж╣рзЛрж╕рзНржЯ ржЪрзЗржХ ржХрж░рж╛ (DNS, NTP, ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ, ржЗрждрзНржпрж╛ржжрж┐) |
| `deploy` | рж╕ржм ржХржирзНржЯрзЗржЗржирж╛рж░ ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рж╛ (Nova, Neutron, Cinder, Glance, ржЗрждрзНржпрж╛ржжрж┐) |
| `post-deploy` | `admin-openrc.sh` ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзЗ |

> тП▒я╕П ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рждрзЗ 10-20 ржорж┐ржирж┐ржЯ рж▓рж╛ржЧрждрзЗ ржкрж╛рж░рзЗред

---

## ЁЯЦея╕П ржзрж╛ржк рззрзн: OpenStack CLI ржЗржирж╕рзНржЯрж▓

```bash
pip install python-openstackclient python-magnumclient
# ржЕржержмрж╛
apt install python3-openstackclient
```
- CLI ржЯрзБрж▓ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕, ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ, ржнрж▓рж┐ржЙржо ржорзНржпрж╛ржирзЗржЬ ржХрж░рж╛ ржпрж╛ржмрзЗред

---

## тЬЕ ржзрж╛ржк рззрзо: ржпрж╛ржЪрж╛ржЗржХрж░ржг (Verification)

```bash
source /etc/kolla/admin-openrc.sh
openstack server list
```
- ржпржжрж┐ ржЦрж╛рж▓рж┐ рждрж╛рж▓рж┐ржХрж╛ ржжрзЗржЦрж╛ржпрж╝, рждрж╛рж╣рж▓рзЗ OpenStack ржХрж╛ржЬ ржХрж░ржЫрзЗред
- ржХрзЛржирзЛ рждрзНрж░рзБржЯрж┐ рж╣рж▓рзЗ рж▓ржЧ ржЪрзЗржХ ржХрж░рзБржи: `docker logs <container_name>`

---

## ЁЯМН ржзрж╛ржк рззрзп: Horizon Dashboard ржП ржкрзНрж░ржмрзЗрж╢

- URL: `http://<your-vm-ip>`
- Username: `admin`
- Password: `kolla`

> ЁЯОп Horizon рж╣рж▓рзЛ OpenStack-ржПрж░ ржУржпрж╝рзЗржм UIред

---

## ЁЯМР ржзрж╛ржк рзирзж: ржкрж╛ржмрж▓рж┐ржХ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рж╕рзЗржЯржЖржк

```bash
export EXT_NET_CIDR='10.0.2.0/24'
export EXT_NET_RANGE='start=10.0.2.150,end=10.0.2.199'
export EXT_NET_GATEWAY='10.0.2.1'
source /etc/kolla/admin-openrc.sh
./kolla-venv/share/kolla-ansible/init-runonce
```
- `init-runonce` рж╕рзНржХрзНрж░рж┐ржкрзНржЯржЯрж┐ ржПржХржЯрж┐ ржбрж┐ржлрж▓рзНржЯ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ, рж░рж╛ржЙржЯрж╛рж░, ржлрзНрж▓рзЗржнрж╛рж░, ржЗржорзЗржЬ рждрзИрж░рж┐ ржХрж░рзЗред
- ржПржЯрж┐ ржжрж┐ржпрж╝рзЗ ржкрзНрж░ржержо ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ рждрзИрж░рж┐ ржХрж░рж╛ ржпрж╛ржпрж╝ред

---

## ЁЯФД ржзрж╛ржк рзирзз: рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░ ржХрж░ржгрзАржпрж╝

ржпржЦржи ржЖржкржирж┐ VM рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ ржХрж░ржмрзЗржи, рждржЦржи ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржПржмржВ NAT ржкрзБржирж░рж╛ржпрж╝ рж╕рзЗржЯ ржХрж░рждрзЗ рж╣ржмрзЗ:

```bash
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
sudo ifconfig br-ex 10.0.2.1 netmask 255.255.255.0 up
sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -A FORWARD -o eth0 -i br-ex -j ACCEPT
iptables -A FORWARD -i eth0 -o br-ex -j ACCEPT
```

> тЪая╕П ржПржЗ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржЫрж╛ржбрж╝рж╛ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕рзЗ ржЗржирзНржЯрж╛рж░ржирзЗржЯ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ рж╣ржмрзЗ ржирж╛ред

---

## ЁЯЪл ржзрж╛ржк рзирзи: ржХрзНрж▓рж╛рж╕рзНржЯрж╛рж░ ржзрзНржмржВрж╕ ржХрж░рж╛

```bash
kolla-ansible -i all-in-one destroy
```
- рж╕ржм ржХржирзНржЯрзЗржЗржирж╛рж░, ржнрж▓рж┐ржЙржо, ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржорзБржЫрзЗ ржлрзЗрж▓рзЗред
- ржкрзБржирж░рж╛ржпрж╝ ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рждрзЗ ржЪрж╛ржЗрж▓рзЗ ржкрзНрж░ржержо ржерзЗржХрзЗ рж╢рзБрж░рзБ ржХрж░рзБржиред

---

## ЁЯФБ ржзрж╛ржк рзирзй: ржкрзЛрж░рзНржЯ ржлрж░ржУржпрж╝рж╛рж░рзНржбрж┐ржВ (SSH to Instance)

```bash
iptables -t nat -A PREROUTING -p tcp --dport 2000 -d 10.0.0.4 -j DNAT --to-destination 10.0.2.155:22
```
- ржПржЯрж┐ ржЖржкржирж╛рж░ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржирзЗрж░ ржкрж╛ржмрж▓рж┐ржХ IP-ржПрж░ 2000 ржкрзЛрж░рзНржЯржХрзЗ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕рзЗрж░ 10.0.2.155:22 ржПрж░ рж╕рж╛ржерзЗ ржорзНржпрж╛ржк ржХрж░рзЗред
- ржлрж▓рзЗ: `ssh -p 2000 user@your_vm_public_ip`

---

## ЁЯУЪ ржЕрждрж┐рж░рж┐ржХрзНржд рж░рж┐рж╕рзЛрж░рзНрж╕

- **Medium ржЖрж░рзНржЯрж┐ржХрзЗрж▓**: [https://gilangvperdana.medium.com/list/openstack-916ca8cdc5cf](https://gilangvperdana.medium.com/list/openstack-916ca8cdc5cf)
- **Victoria ржнрж╛рж░рзНрж╕ржи**: [https://gist.github.com/gilangvperdana/e74b3536c0c8786c68cb3ed51e4acbd2](https://gist.github.com/gilangvperdana/e74b3536c0c8786c68cb3ed51e4acbd2)
- **Xena AIO Gist**: [https://gist.github.com/gilangvperdana/7042caa2af2c7729c798581a86509e8d](https://gist.github.com/gilangvperdana/7042caa2af2c7729c798581a86509e8d)

---

## тЭУ рж╕рж╛ржзрж╛рж░ржг рж╕ржорж╕рзНржпрж╛ ржУ рж╕ржорж╛ржзрж╛ржи

| рж╕ржорж╕рзНржпрж╛ | рж╕ржорж╛ржзрж╛ржи |
|--------|--------|
| `prechecks` ржлрзЗржЗрж▓ | `hosts` ржлрж╛ржЗрж▓, NTP, DNS ржЪрзЗржХ ржХрж░рзБржи |
| ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕рзЗ ржЗржирзНржЯрж╛рж░ржирзЗржЯ ржирзЗржЗ | `iptables`, `ip_forward`, `br_ex` ржЪрзЗржХ ржХрж░рзБржи |
| Dashboard ржУржкрзЗржи рж╣ржпрж╝ ржирж╛ | ржлрж╛ржпрж╝рж╛рж░ржУржпрж╝рж╛рж▓ ржмржирзНржз ржХрж░рзБржи ржмрж╛ ржкрзЛрж░рзНржЯ 80 ржУржкрзЗржи ржХрж░рзБржи |
| `kolla-ansible deploy` ржлрзЗржЗрж▓ | `docker logs <failed_container>` ржжрзЗржЦрзБржи |

---

## тЬЕ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк

ржПржЗ ржЧрж╛ржЗржбржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЖржкржирж┐:

- ржПржХржЯрж┐ **OpenStack Xena** AIO ржХрзНрж▓рж╛ржЙржб рждрзИрж░рж┐ ржХрж░рзЗржЫрзЗржиред
- рж╕ржмржХрж┐ржЫрзБ **Docker + Ansible** ржжрж┐ржпрж╝рзЗ ржЕржЯрзЛржорзЗржЯ ржХрж░рзЗржЫрзЗржиред
- ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕, ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ, рж╕рзНржЯрзЛрж░рзЗржЬ ржорзНржпрж╛ржирзЗржЬ ржХрж░рждрзЗ ржкрж╛рж░ржЫрзЗржиред
- CLI ржПржмржВ GUI (Horizon) ржЙржнржпрж╝ ржкржжрзНржзрждрж┐рждрзЗ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░ржЫрзЗржиред

---

ржпржжрж┐ ржЖржкржирж┐ ржЪрж╛ржи, ржЖржорж┐ ржПржЯрж┐ ржПржХржЯрж┐ **bash рж╕рзНржХрзНрж░рж┐ржкрзНржЯрзЗ** рж░рзВржкрж╛ржирзНрждрж░ ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░рж┐, ржмрж╛ ржЖржкржирж╛рж░ VM ржП ржХрж╛рж╕рзНржЯржорж╛ржЗржЬ ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░рж┐ред

ржЪрж╛ржЗрж▓рзЗ ржЖржкржирж┐ **Terraform**, **multi-node**, ржмрж╛ **HA рж╕рзЗржЯржЖржк** ржирж┐ржпрж╝рзЗржУ ржЬрж╛ржирждрзЗ ржкрж╛рж░рзЗржиред

ржЖржкржирж┐ ржХрж┐ ржПржЯрж┐ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржЖржХрж╛рж░рзЗ ржЪрж╛ржи? ЁЯШК

### USER
ржкрзНрж░рж╢рзНржи рззржГ  
ржзрж╛ржк рзи: ржПржХржЯрж┐ ржбрж╛ржорж┐ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ рждрзИрж░рж┐ (br_ex_port)
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
br_ex_port рж╣рж▓рзЛ ржПржХржЯрж┐ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕, ржпрж╛ Neutron-ржПрж░ external network рж╣рж┐рж╕рж╛ржмрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржмрзЗред
ржПржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржирзЗрж░ ржмрж╛ржЗрж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ (public/flat network) ржПрж░ ржЬржирзНржпред
ржПржЗ ржЕржВрж╢ржЯрж┐ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржнрж╛ржмрзЗ ржмрзЛржЭрж╛ржи ржПржмржВ ржХржЦржи ржПржЗ ржбрж╛ржорж┐ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ рждрзИрж░рж┐ ржХрж░рждрзЗ рж╣рзЯ , ржХрзЗржирзЛ ржПржмржВ ржХрж┐ржнрж╛ржмрзЗ?

ржкрзНрж░рж╢рзНржи рзиржГ
  ржзрж╛ржк рзирзз: рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░ ржХрж░ржгрзАржпрж╝
ржпржЦржи ржЖржкржирж┐ VM рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ ржХрж░ржмрзЗржи, рждржЦржи ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржПржмржВ NAT ржкрзБржирж░рж╛ржпрж╝ рж╕рзЗржЯ ржХрж░рждрзЗ рж╣ржмрзЗ:

bash


1
2
3
4
5
6
7
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
sudo ifconfig br-ex 10.0.2.1 netmask 255.255.255.0 up
sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -A FORWARD -o eth0 -i br-ex -j ACCEPT
iptables -A FORWARD -i eth0 -o br-ex -j ACCEPT
тЪая╕П ржПржЗ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржЫрж╛ржбрж╝рж╛ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕рзЗ ржЗржирзНржЯрж╛рж░ржирзЗржЯ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ рж╣ржмрзЗ ржирж╛ред 

ржПржЗ ржЕржВрж╢ржЯрж┐ржУ ржмрзЛржЭрж╛ржи ржПржмржВ ржХржЦржи ржХрзЗржирзЛ, ржХрж┐ржнрж╛ржмрзЗред ржПржмржВ ржкрзНрж░рждрзНржпрзЗржХржмрж╛рж░ VM Restart ржХрж░рж╛рж░ ржкрж░рзЗ ржкрзНрж░рждрзНржпрзЗржХржмрж╛рж░ ржПржЗ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржЪрж╛рж▓рж╛рждрзЗ рж╣ржмрзЗ?


### ASSISTANT
ржЕржмрж╢рзНржпржЗ! ржирж┐ржЪрзЗ ржЖржкржирж╛рж░ ржжрзБржЯрж┐ ржкрзНрж░рж╢рзНржирзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржПржмржВ ржзрж╛рж░рж╛ржмрж╛рж╣рж┐ржХ ржЙрждрзНрждрж░ ржжрзЗржУржпрж╝рж╛ рж╣рж▓рзЛред

---

## тЬЕ **ржкрзНрж░рж╢рзНржи рзз: `br_ex_port` ржбрж╛ржорж┐ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ тАФ ржХрзЗржи, ржХржЦржи ржПржмржВ ржХрж┐ржнрж╛ржмрзЗ?**

### ЁЯФ╣ ржХрж┐ рж╣ржЪрзНржЫрзЗ ржПржЦрж╛ржирзЗ?

```bash
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
```

ржПржЗ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржПржХржЯрж┐ **TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕** (`br_ex_port`) рждрзИрж░рж┐ ржХрж░ржЫрзЗ ржПржмржВ рждрж╛ ржЪрж╛рж▓рзБ (up) ржХрж░ржЫрзЗред  
ржПржЯрж┐ ржПржХржЯрж┐ **ржбрж╛ржорж┐ ржмрж╛ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕**, ржпрж╛ ржЖрж╕рж▓рзЗ ржХрзЛржирзЛ рж╢рж╛рж░рзАрж░рж┐ржХ рж╣рж╛рж░рзНржбржУржпрж╝рзНржпрж╛рж░ ржиржпрж╝ тАФ ржПржЯрж┐ рж▓рж┐ржирж╛ржХрзНрж╕ ржХрж╛рж░рзНржирзЗрж▓ ржжрзНржмрж╛рж░рж╛ рж╕рж╛ржкрзЛрж░рзНржЯрзЗржб ржПржХржЯрж┐ рж╕ржлржЯржУржпрж╝рзНржпрж╛рж░-ржнрж┐рждрзНрждрж┐ржХ ржбрж┐ржнрж╛ржЗрж╕ред

---

### ЁЯОп ржХрзЗржи ржПржЯрж┐ ржкрзНрж░ржпрж╝рзЛржЬржи?

OpenStack-ржП **Neutron** рж╣рж▓рзЛ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрж┐ржВ рж╕рж╛рж░рзНржнрж┐рж╕ред Neutron ржПржоржи ржПржХржЯрж┐ ржлрж╛ржВрж╢ржи рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ ржпрзЗржЦрж╛ржирзЗ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржи (ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕) ржЧрзБрж▓рзЛ ржмрж╛ржЗрж░рзЗрж░ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд рж╣рждрзЗ ржкрж╛рж░рзЗред ржПржЯрж┐ ржХрж░рж╛рж░ ржЬржирзНржп Neutron-ржХрзЗ ржПржХржЯрж┐ **external network** ржПрж░ ржкрзНрж░ржпрж╝рзЛржЬржи рж╣ржпрж╝ред

> ржХрж┐ржирзНрждрзБ ржЖржорж╛ржжрзЗрж░ VM-ржП рждрзЛ рж╢рзБржзрзБ `eth0` ржЖржЫрзЗ, ржпрж╛ ржХрзНрж▓рж╛ржЙржб ржкрзНрж░рзЛржнрж╛ржЗржбрж╛рж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНрждред рждрж╛рж╣рж▓рзЗ Neutron ржХрзАржнрж╛ржмрзЗ ржмрж╛ржЗрж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рждрзИрж░рж┐ ржХрж░ржмрзЗ?

ржЙрждрзНрждрж░: **ржЖржорж░рж╛ ржирж┐ржЬрзЗрж░рж╛ржЗ ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ external network рждрзИрж░рж┐ ржХрж░ржм**, ржпрж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржкрзНрж░ржпрж╝рзЛржЬржи тАФ рж╕рзЗржЯрж╛ржЗ рж╣рж▓рзЛ `br_ex_port`ред

---

### ЁЯУМ ржХржЦржи ржПржЯрж┐ ржХрж░рж╛ рж╣ржпрж╝?

- OpenStack ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рж╛рж░ **ржЖржЧрзЗ**, ржЕрж░рзНржерж╛рзО Kolla-Ansible ржЪрж╛рж▓рж╛ржирзЛрж░ ржЖржЧрзЗред
- ржПржЯрж┐ ржПржХржмрж╛рж░ ржХрж░рж▓рзЗржЗ рж╣ржпрж╝ (VM ржкрж╛рж░рзНржорж╛ржирзЗржирзНржЯ ржирж╛ ржорзБржЫрж╛ ржкрж░рзНржпржирзНржд), ржХрж┐ржирзНрждрзБ **рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░ ржПржЯрж┐ ржорзБржЫрзЗ ржпрж╛ржпрж╝** (ржпржжрж┐ рж╕рзНржерж╛ржпрж╝рзА ржирж╛ ржХрж░рж╛ рж╣ржпрж╝)ред

---

### ЁЯзй ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?

1. `ip tuntap add mode tap br_ex_port`:
   - `tuntap` ржХрж╛рж░рзНржирзЗрж▓ ржоржбрж┐ржЙрж▓ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржПржХржЯрж┐ TAP ржбрж┐ржнрж╛ржЗрж╕ рждрзИрж░рж┐ ржХрж░рзЗред
   - `mode tap`: ржПржЯрж┐ рж▓рзЗржпрж╝рж╛рж░-2 (ржбрзЗржЯрж╛ рж▓рж┐ржЩрзНржХ рж▓рзЗржпрж╝рж╛рж░) ржбрж┐ржнрж╛ржЗрж╕ рждрзИрж░рж┐ ржХрж░рзЗ, ржпрж╛ Ethernet frame ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░рзЗред
   - `br_ex_port`: ржбрж┐ржнрж╛ржЗрж╕рзЗрж░ ржирж╛ржоред

2. `ip link set dev br_ex_port up`:
   - ржбрж┐ржнрж╛ржЗрж╕ржЯрж┐ржХрзЗ "up" ржЕржмрж╕рзНржерж╛ржпрж╝ ржирзЗржпрж╝рж╛ рж╣ржЪрзНржЫрзЗ, ржпрж╛рждрзЗ ржПржЯрж┐ ржЯрзНрж░рж╛ржлрж┐ржХ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░рзЗред

3. ржкрж░ржмрж░рзНрждрзАрждрзЗ, Kolla-Ansible/Neutron ржПржЗ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ржЯрж┐ржХрзЗ ржПржХржЯрж┐ **Linux bridge** (`br-ex`) ржПрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд ржХрж░рзЗред
   - ржПржЗ `br-ex` рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝ **external gateway** рж╣рж┐рж╕рж╛ржмрзЗред
   - ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ржЧрзБрж▓рзЛрж░ Floating IP ржПржЗ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗ ржЕрзНржпрж╛рж╕рж╛ржЗржи рж╣ржпрж╝ред

---

### ЁЯП╖я╕П ржПржЯрж┐ ржХрзЛржи ржзрж░ржирзЗрж░ external network?

- ржПржЦрж╛ржирзЗ `flat` ржмрж╛ `vlan` provider network рж╣рж┐рж╕рж╛ржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝ред
- `neutron_external_interface: "br_ex_port"` тАФ `globals.yml`-ржП ржПржЯрж┐ рж╕рзЗржЯ ржХрж░рж╛ рж╣ржпрж╝ред
- Neutron ржПржЗ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ржХрзЗ ржмрзНрж░рж┐ржЬ (`br-ex`) ржПрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд ржХрж░рзЗ ржПржмржВ ржПржЯрж┐ржХрзЗ external network рж╣рж┐рж╕рж╛ржмрзЗ ржШрзЛрж╖ржгрж╛ ржХрж░рзЗред

---

### тЭЧ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирзЛржЯ:

- ржПржЯрж┐ ржХрзЗржмрж▓ **All-in-One (AIO)** ржмрж╛ **рж╕рж┐ржЩрзНржЧрзЗрж▓ ржирзЛржб** рж╕рзЗржЯржЖржкрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржпрж╝ред
- **ржкрзНрж░рзЛржбрж╛ржХрж╢ржи ржорж╛рж▓рзНржЯрж┐-ржирзЛржб** рж╕рзЗржЯржЖржкрзЗ, рж╕рж╛ржзрж╛рж░ржгржд ржПржХржЯрж┐ ржЖрж▓рж╛ржжрж╛ ржлрж┐ржЬрж┐ржХрзНржпрж╛рж▓ NIC ржмрж╛ VLAN trunk ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝ред
- ржПржЦрж╛ржирзЗ ржЖржорж░рж╛ ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржжрж┐ржпрж╝рзЗ рж╕рзЗржЯрж╛рж░ рж╕рж┐ржорзБрж▓рзЗрж╢ржи ржХрж░ржЫрж┐ред

---

## тЬЕ **ржкрзНрж░рж╢рзНржи рзи: рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рж╕рзЗржЯржЖржк тАФ ржХрзЗржи, ржХржЦржи, ржХрж┐ржнрж╛ржмрзЗ?**

### ЁЯФБ ржХрзЗржи ржПржЗ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржкрзНрж░ржпрж╝рзЛржЬржи ржкрзНрж░рждрзНржпрзЗржХржмрж╛рж░ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░?

ржХрж╛рж░ржг: **`br_ex_port`, `br-ex`, NAT рж░рзБрж▓рж╕ ржПржмржВ IP forwarding` рж╣рж▓рзЛ volatile (ржЕрж╕рзНржерж╛ржпрж╝рзА) ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи**ред  
ржПржЧрзБрж▓рзЛ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░ ржорзЗржорзЛрж░рж┐ ржерзЗржХрзЗ ржорзБржЫрзЗ ржпрж╛ржпрж╝, ржХрж╛рж░ржг:

- `ip tuntap` ржжрж┐ржпрж╝рзЗ рждрзИрж░рж┐ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ ржорзБржЫрзЗ ржпрж╛ржпрж╝ред
- `iptables` рж░рзБрж▓рж╕ RAM-ржП ржерж╛ржХрзЗ, ржлрж╛ржЗрж▓ рж╕рж┐рж╕рзНржЯрзЗржорзЗ рж╕рзЗржн ржирж╛ ржХрж░рж▓рзЗ ржорзБржЫрзЗ ржпрж╛ржпрж╝ред
- `ip_forward` ржбрж┐ржлрж▓рзНржЯрзЗ 0 (ржмржирзНржз) ржерж╛ржХрзЗред

рждрж╛ржЗ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░ ржПржЧрзБрж▓рзЛ ржкрзБржирж░рж╛ржпрж╝ рж╕рзЗржЯ ржХрж░рждрзЗ рж╣ржпрж╝ред

---

### ЁЯФз ржХржорж╛ржирзНржбржЧрзБрж▓рзЛрж░ ржмрзНржпрж╛ржЦрзНржпрж╛:

```bash
sudo ip tuntap add mode tap br_ex_port
sudo ip link set dev br_ex_port up
```
- ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ рждрзИрж░рж┐ ржПржмржВ ржЪрж╛рж▓рзБ ржХрж░рж╛ред

```bash
sudo ifconfig br-ex 10.0.2.1 netmask 255.255.255.0 up
```
- `br-ex` ржмрзНрж░рж┐ржЬрзЗ (ржпрж╛ Neutron рждрзИрж░рж┐ ржХрж░рзЗ) ржПржХржЯрж┐ IP ржЕрзНржпрж╛рж╕рж╛ржЗржи ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред
- ржПржЯрж┐ external network-ржПрж░ **gateway** рж╣рж┐рж╕рж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗред
- `10.0.2.1` тЖТ ржПржЗ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗрж░ ржбрж┐ржлрж▓рзНржЯ ржЧрзЗржЯржУржпрж╝рзЗред

```bash
sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE
```
- **NAT/Masquerading**: ржпрзЗржХрзЛржирзЛ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ ржерзЗржХрзЗ `10.0.2.0/24` ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржерзЗржХрзЗ ржмрж╛ржЗрж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ (`eth0`) ржП ржпрж╛ржУржпрж╝рж╛ ржЯрзНрж░рж╛ржлрж┐ржХрзЗрж░ ржЬржирзНржп source IP ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛ рж╣ржмрзЗред
- ржлрж▓рзЗ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗ ржпрзЗрждрзЗ ржкрж╛рж░ржмрзЗред

```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
```
- рж▓рж┐ржирж╛ржХрзНрж╕ ржХрж╛рж░рзНржирзЗрж▓ржХрзЗ ржмрж▓рж╛ рж╣ржЪрзНржЫрзЗ ржпрзЗ ржПржЯрж┐ **IP ржлрж░ржУржпрж╝рж╛рж░рзНржбрж┐ржВ** ржЪрж╛рж▓рзБ ржХрж░рзБржХред
- ржЕрж░рзНржерж╛рзО, ржПржХ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржерзЗржХрзЗ ржЖрж╕рж╛ ржЯрзНрж░рж╛ржлрж┐ржХ ржЕржирзНржп ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗ ржлрж░ржУржпрж╝рж╛рж░рзНржб ржХрж░рж╛ ржпрж╛ржмрзЗред

```bash
iptables -A FORWARD -o eth0 -i br-ex -j ACCEPT
iptables -A FORWARD -i eth0 -o br-ex -j ACCEPT
```
- ржлрж░ржУржпрж╝рж╛рж░рзНржбрж┐ржВ ржЪрж╛рж▓рзБ ржерж╛ржХрж▓рзЗржУ, ржбрж┐ржлрж▓рзНржЯ `FORWARD` ржЪрзЗржЗржирзЗ ржкрж▓рж┐рж╕рж┐ `DROP` рж╣рждрзЗ ржкрж╛рж░рзЗред
- ржПржЗ рж░рзБрж▓рж╕ ржжрзБржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ:
  - `br-ex` тЖТ `eth0` (outbound) traffic allowed.
  - `eth0` тЖТ `br-ex` (inbound, e.g., replies) traffic allowed.

---

### тЭУ ржкрзНрж░рждрж┐ржмрж╛рж░ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗрж░ ржкрж░ ржХрж┐ ржХржорж╛ржирзНржбржЧрзБрж▓рзЛ ржЪрж╛рж▓рж╛рждрзЗ рж╣ржмрзЗ?

тЬЕ **рж╣рзНржпрж╛ржБ**, ржпржжрж┐ ржЖржкржирж┐ ржПржЧрзБрж▓рзЛржХрзЗ **рж╕рзНржерж╛ржпрж╝рзА (persistent)** ржирж╛ ржХрж░рзЗржиред

ржХрж┐ржирзНрждрзБ ржЖржкржирж┐ ржЪрж╛ржЗрж▓рзЗ ржПржЧрзБрж▓рзЛржХрзЗ **ржЕржЯрзЛржорзЗржЯ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи**:

#### тЬЕ рж╕ржорж╛ржзрж╛ржи: рж╕рзНржерж╛ржпрж╝рзА ржХрж░рж╛рж░ ржЙржкрж╛ржпрж╝

##### 1. **`/etc/rc.local` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи (Ubuntu 20.04)**

```bash
sudo nano /etc/rc.local
```

```bash
#!/bin/bash
ip tuntap add mode tap br_ex_port
ip link set dev br_ex_port up
ifconfig br-ex 10.0.2.1 netmask 255.255.255.0 up
iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -A FORWARD -o eth0 -i br-ex -j ACCEPT
iptables -A FORWARD -i eth0 -o br-ex -j ACCEPT
exit 0
```

```bash
sudo chmod +x /etc/rc.local
sudo systemctl enable rc-local
```

##### 2. **`iptables-persistent` ржЗржирж╕рзНржЯрж▓ ржХрж░рзБржи**

```bash
sudo apt install iptables-persistent -y
sudo netfilter-persistent save
```

ржПржЯрж┐ `iptables` рж░рзБрж▓рж╕ рж╕рзЗржн ржХрж░ржмрзЗ ржПржмржВ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ рж▓рзЛржб ржХрж░ржмрзЗред

##### 3. **systemd service рждрзИрж░рж┐ ржХрж░рзБржи**

ржЖржкржирж┐ ржПржХржЯрж┐ ржХрж╛рж╕рзНржЯржо systemd рж╕рж╛рж░рзНржнрж┐рж╕ рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи ржпрж╛ ржмрзБржЯрзЗрж░ рж╕ржоржпрж╝ ржПржЗ рж╕рзЗржЯржЖржк ржЪрж╛рж▓рж╛ржмрзЗред

---

## тЬЕ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк

| ржмрж┐рж╖ржпрж╝ | ржмрзНржпрж╛ржЦрзНржпрж╛ |
|-------|----------|
| `br_ex_port` | Neutron-ржПрж░ external network ржПрж░ ржЬржирзНржп ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ |
| ржХрзЗржи? | ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржирзЗ ржмрж╛ржЗрж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рж╕рж┐ржорзБрж▓рзЗржЯ ржХрж░рждрзЗ |
| ржХржЦржи? | OpenStack ржбрж┐ржкрзНрж▓ржпрж╝рзЗрж░ ржЖржЧрзЗ |
| рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ ржХрж┐ рж╣ржпрж╝? | ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржПржмржВ NAT ржорзБржЫрзЗ ржпрж╛ржпрж╝ |
| рж╕ржорж╛ржзрж╛ржи | `rc.local`, `iptables-persistent`, ржмрж╛ systemd рж╕рж╛рж░рзНржнрж┐рж╕ ржжрж┐ржпрж╝рзЗ рж╕рзНржерж╛ржпрж╝рзА ржХрж░рзБржи |

---

ржпржжрж┐ ржЖржкржирж┐ ржЪрж╛ржи, ржЖржорж┐ ржЖржкржирж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ **рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржмрж╛ systemd service ржлрж╛ржЗрж▓** рждрзИрж░рж┐ ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░рж┐ ржпрж╛ ржкрзНрж░рждрж┐ ржмрзБржЯрзЗ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржПржЗ рж╕рзЗржЯржЖржк ржЪрж╛рж▓рзБ ржХрж░ржмрзЗред

ржЪрж╛ржи ржХрж┐? ЁЯШК

### USER
Explain this section to me in more detail

```
TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕
```

### ASSISTANT
ржЕржмрж╢рзНржпржЗ! ржЪрж▓рзБржи ржмрж┐рж╕рзНрждрж╛рж░рж┐рждржнрж╛ржмрзЗ ржмрзБржЭрж┐ тАФ **TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕** ржХрзА, ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ, ржПржмржВ OpenStack-ржПрж░ ржорждрзЛ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓рж╛ржЗржЬржб ржкрж░рж┐ржмрзЗрж╢рзЗ ржПржЯрж┐ ржХрзЗржи ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржгред

---

## ЁЯФ╣ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржХрзА? (What is a TAP Interface?)

**TAP (Terminal Access Point)** рж╣рж▓рзЛ рж▓рж┐ржирж╛ржХрзНрж╕ ржХрж╛рж░рзНржирзЗрж▓ ржжрзНржмрж╛рж░рж╛ рж╕рж╛ржкрзЛрж░рзНржЯрзЗржб ржПржХржЯрж┐ **рж╕ржлржЯржУржпрж╝рзНржпрж╛рж░-ржнрж┐рждрзНрждрж┐ржХ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржбрж┐ржнрж╛ржЗрж╕**, ржпрж╛ **рж▓рзЗржпрж╝рж╛рж░ 2 (Data Link Layer)** ржП ржХрж╛ржЬ ржХрж░рзЗред  
ржЕрж░рзНржерж╛рзО, ржПржЯрж┐ **ржЗржерж╛рж░ржирзЗржЯ ржлрзНрж░рзЗржо** (Ethernet frames) ржкрзНрж░рж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░рзЗ тАФ ржпрзЗржоржи ржЖржкржирж╛рж░ ржХржорзНржкрж┐ржЙржЯрж╛рж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХрж╛рж░рзНржб (NIC) ржХрж░рзЗред

> ЁЯТб ржоржирзЗ рж░рж╛ржЦрзБржи:  
> - **TAP** тЖТ Layer 2 тЖТ Ethernet frames тЖТ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржи/ржХржирзНржЯрзЗржЗржирж╛рж░рзЗрж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧрзЗрж░ ржЬржирзНржпред  
> - **TUN** тЖТ Layer 3 тЖТ IP packets тЖТ рж░рж╛ржЙржЯрж┐ржВ ржмрж╛ VPN-ржПрж░ ржЬржирзНржпред

---

## ЁЯзй TAP ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?

TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржПржХржЯрж┐ **"ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХрж╛рж░рзНржб"**-ржПрж░ ржорждрзЛ ржЖржЪрж░ржг ржХрж░рзЗред ржПржЯрж┐:

1. ржХрж╛рж░рзНржирзЗрж▓ ржПржмржВ ржЗржЙржЬрж╛рж░-рж╕рзНржкрзЗрж╕ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи (ржпрзЗржоржи QEMU, OpenVPN, Neutron) ржПрж░ ржоржзрзНржпрзЗ ржПржХржЯрж┐ ржмрзНрж░рж┐ржЬ рждрзИрж░рж┐ ржХрж░рзЗред
2. ржХрж╛рж░рзНржирзЗрж▓ ржПржЦрж╛ржирзЗ ржпрзЗ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЯрзНрж░рж╛ржлрж┐ржХ ржкрж╛ржарж╛ржпрж╝ (ржЗржерж╛рж░ржирзЗржЯ ржлрзНрж░рзЗржо), рждрж╛ ржЗржЙржЬрж╛рж░-рж╕рзНржкрзЗрж╕ ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржкржбрж╝рждрзЗ ржкрж╛рж░рзЗред
3. ржЖржмрж╛рж░ ржЗржЙржЬрж╛рж░-рж╕рзНржкрзЗрж╕ ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржпржжрж┐ ржХрзЛржирзЛ ржлрзНрж░рзЗржо ржкрж╛ржарж╛ржпрж╝, ржХрж╛рж░рзНржирзЗрж▓ рждрж╛ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рж╕рзНржЯрзНржпрж╛ржХрзЗ ржврзБржХрж┐ржпрж╝рзЗ ржжрзЗржпрж╝ред

### ЁЯУМ ржЙржжрж╛рж╣рж░ржг:
ржпржЦржи ржЖржкржирж┐ ржПржХржЯрж┐ KVM ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржи ржЪрж╛рж▓рж╛ржи, QEMU ржПржХржЯрж┐ TAP ржбрж┐ржнрж╛ржЗрж╕ рждрзИрж░рж┐ ржХрж░рзЗ (ржпрзЗржоржи `tap0`) ржПржмржВ VM-ржПрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХрж╛рж░рзНржбржХрзЗ рждрж╛рж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд ржХрж░рзЗред ржлрж▓рзЗ VM ржерзЗржХрзЗ ржЖрж╕рж╛ ржЯрзНрж░рж╛ржлрж┐ржХ ржХрж╛рж░рзНржирзЗрж▓рзЗрж░ ржорж╛ржзрзНржпржорзЗ рж╣рзЛрж╕рзНржЯрзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗ ржпрзЗрждрзЗ ржкрж╛рж░рзЗред

---

## ЁЯМР OpenStack-ржП TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕рзЗрж░ ржнрзВржорж┐ржХрж╛

OpenStack-ржП **Neutron** ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрж┐ржВ рж╕рж╛рж░рзНржнрж┐рж╕ рж╣рж▓рзЛ ржпрзЗ ржХржорзНржкрзЛржирзЗржирзНржЯ ржпрж╛ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ, рж░рж╛ржЙржЯрж╛рж░, ржлрж╛ржпрж╝рж╛рж░ржУржпрж╝рж╛рж▓, рж▓рзЛржб ржмрзНржпрж╛рж▓рзЗржирзНрж╕рж╛рж░ ржЗрждрзНржпрж╛ржжрж┐ ржорзНржпрж╛ржирзЗржЬ ржХрж░рзЗред

### тЬЕ ржХрзЗржи `br_ex_port` рж╣рж┐рж╕рж╛ржмрзЗ TAP ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝?

ржЖржорж╛ржжрзЗрж░ рж╕рзЗржЯржЖржкрзЗ (`kolla-ansible all-in-one`) ржЖржорж░рж╛ рж╢рзБржзрзБржорж╛рждрзНрж░ **ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржи** ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐ред ржХрж┐ржирзНрждрзБ OpenStack ржПржоржи ржПржХржЯрж┐ external network ржЪрж╛ржпрж╝ ржпрзЗржЦрж╛ржирзЗ:

- ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ржЧрзБрж▓рзЛ **Floating IP** ржкрж╛ржмрзЗред
- ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ржЧрзБрж▓рзЛ **ржмрж╛ржЗрж░рзЗрж░ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗ** ржпрзЗрждрзЗ ржкрж╛рж░ржмрзЗред

ржХрж┐ржирзНрждрзБ ржЖржорж╛ржжрзЗрж░ VM-ржП рж╢рзБржзрзБ `eth0` ржЖржЫрзЗ, ржпрж╛ ржХрзНрж▓рж╛ржЙржб ржкрзНрж░рзЛржнрж╛ржЗржбрж╛рж░рзЗрж░ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНрждред ржЖржорж░рж╛ рж╕рж░рж╛рж╕рж░рж┐ `eth0`-ржХрзЗ external network рж╣рж┐рж╕рж╛ржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рж┐ ржирж╛ тАФ ржПржЯрж┐ ржЭрзБржБржХрж┐ржкрзВрж░рзНржг ржПржмржВ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржирзЗрж░ ржжрзГрж╖рзНржЯрж┐ржХрзЛржг ржерзЗржХрзЗ ржнрзБрж▓ред

рж╕ржорж╛ржзрж╛ржи? тЖТ **ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ external network рждрзИрж░рж┐ ржХрж░рзБржи**, ржпрж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржкрзНрж░ржпрж╝рзЛржЬржиред

### ЁЯЫая╕П ржПржЦрж╛ржирзЗ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕рзЗрж░ ржмрзНржпржмрж╣рж╛рж░:

```bash
sudo ip tuntap add mode tap br_ex_port
```

- ржПржЯрж┐ ржПржХржЯрж┐ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржЗржерж╛рж░ржирзЗржЯ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ рждрзИрж░рж┐ ржХрж░рзЗред
- Neutron ржкрж░ржмрж░рзНрждрзАрждрзЗ ржПржЯрж┐ржХрзЗ ржПржХржЯрж┐ **Linux bridge (`br-ex`)**-ржПрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд ржХрж░рзЗред
- `br-ex` рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝ **external gateway** рж╣рж┐рж╕рж╛ржмрзЗред
- ржПржЦржи ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ржЧрзБрж▓рзЛ Floating IP ржкрж╛ржпрж╝ ржПржмржВ NAT ржПрж░ ржорж╛ржзрзНржпржорзЗ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗ ржпрзЗрждрзЗ ржкрж╛рж░рзЗред

---

## ЁЯФД TAP vs TUN vs VETH: ржкрж╛рж░рзНржержХрзНржп

| ржирж╛ржо | рж▓рзЗржпрж╝рж╛рж░ | ржмрзНржпржмрж╣рж╛рж░ | ржЙржжрж╛рж╣рж░ржг |
|-----|-------|--------|--------|
| **TAP** | Layer 2 (Data Link) | ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржи, ржХржирзНржЯрзЗржЗржирж╛рж░ | KVM, OpenStack Neutron |
| **TUN** | Layer 3 (Network) | IP ржнрж┐рждрзНрждрж┐ржХ ржЯрж╛ржирзЗрж▓рж┐ржВ | OpenVPN, WireGuard |
| **VETH** | Layer 2 | ржХржирзНржЯрзЗржЗржирж╛рж░ тЖФ рж╣рзЛрж╕рзНржЯ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрж┐ржВ | Docker, LXC |

> тЬЕ ржЖржорж╛ржжрзЗрж░ ржХрзНрж╖рзЗрждрзНрж░рзЗ `TAP` ржХрж╛рж░ржг Neutron-ржПрж░ external network ржПржХржЯрж┐ Layer 2 ржбрж┐ржнрж╛ржЗрж╕ ржЪрж╛ржпрж╝ред

---

## тЪЩя╕П ржХрж┐ржнрж╛ржмрзЗ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ рждрзИрж░рж┐ рж╣ржпрж╝?

### 1. `tun` ржХрж╛рж░рзНржирзЗрж▓ ржоржбрж┐ржЙрж▓ рж▓рзЛржб рж╣ржпрж╝:
```bash
lsmod | grep tun
# ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ: sudo modprobe tun
```

### 2. `ip tuntap` ржХржорж╛ржирзНржб ржжрж┐ржпрж╝рзЗ рждрзИрж░рж┐:
```bash
sudo ip tuntap add mode tap br_ex_port
```
- `mode tap`: TAP ржбрж┐ржнрж╛ржЗрж╕ рждрзИрж░рж┐ ржХрж░рзБржиред
- `br_ex_port`: ржбрж┐ржнрж╛ржЗрж╕рзЗрж░ ржирж╛ржоред

### 3. ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржЪрж╛рж▓рзБ ржХрж░рзБржи:
```bash
sudo ip link set dev br_ex_port up
```

### 4. ржмрзНрж░рж┐ржЬрзЗрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд ржХрж░рзБржи (Neutron рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ ржХрж░рзЗ):
```bash
sudo brctl addbr br-ex
sudo brctl addif br-ex br_ex_port
```

---

## тЭЧ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирзЛржЯ

- TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ **рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ ржорзБржЫрзЗ ржпрж╛ржпрж╝** тАФ ржПржЯрж┐ RAM-ржП ржерж╛ржХрзЗред
- рж╕рзНржерж╛ржпрж╝рзА ржХрж░рждрзЗ рж╣рж▓рзЗ `/etc/rc.local`, `systemd service`, ржмрж╛ ржХрж╛рж╕рзНржЯржо рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред
- ржПржЯрж┐ **ржХрзЗржмрж▓ AIO/Development рж╕рзЗржЯржЖржкрзЗ** ржмрзНржпржмрж╣рзГржд рж╣ржпрж╝ред
- **ржкрзНрж░рзЛржбрж╛ржХрж╢ржирзЗ**, рж╕рж╛ржзрж╛рж░ржгржд ржПржХржЯрж┐ ржЖрж▓рж╛ржжрж╛ ржлрж┐ржЬрж┐ржХрзНржпрж╛рж▓ NIC ржмрж╛ VLAN trunk ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝ external network-ржПрж░ ржЬржирзНржпред

---

## тЬЕ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк

| ржмрж┐рж╖ржпрж╝ | ржмрзНржпрж╛ржЦрзНржпрж╛ |
|-------|----------|
| **TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕** | рж▓рзЗржпрж╝рж╛рж░ 2-ржП ржХрж╛ржЬ ржХрж░рзЗ, ржЗржерж╛рж░ржирзЗржЯ ржлрзНрж░рзЗржо ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзЗ |
| **ржХрж╛ржЬ** | ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржи/ржХржирзНржЯрзЗржЗржирж╛рж░рзЗрж░ рж╕рж╛ржерзЗ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржпрзЛржЧрж╛ржпрзЛржЧ рж╕рзНржерж╛ржкржи |
| **OpenStack-ржП** | Neutron-ржПрж░ external network рж╣рж┐рж╕рж╛ржмрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржпрж╝ |
| **ржХрзЗржи ржжрж░ржХрж╛рж░?** | ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржорзЗрж╢рж┐ржирзЗ external network рж╕рж┐ржорзБрж▓рзЗрж╢ржи ржХрж░рждрзЗ |
| **рж╕рзНржерж╛ржпрж╝рзА ржХрж░рж╛** | `rc.local`, `iptables-persistent`, systemd service ржжрж┐ржпрж╝рзЗ |

---

ржпржжрж┐ ржЖржкржирж┐ ржЪрж╛ржи, ржЖржорж┐ ржЖржкржирж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ **рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ** ржмрж╛ **systemd service file** рждрзИрж░рж┐ ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░рж┐ ржпрж╛ ржкрзНрж░рждрж┐ ржмрзБржЯрзЗ TAP ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржПржмржВ NAT рж╕рзЗржЯ ржХрж░ржмрзЗред

ржЪрж╛ржи ржХрж┐? ЁЯШК
